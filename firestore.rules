rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== BLOGS COLLECTION =====
    match /blogs/{blogId} {
      // Public: Allow anyone to read published blogs
      // Admin: Authenticated users can read ALL blogs (published + drafts)
      allow read: if resource.data.published == true || request.auth != null;
      
      // Admin: Only authenticated users can create, update, delete
      allow write: if request.auth != null;
    }

    // ===== STORIES COLLECTION =====
    match /stories/{storyId} {
      // Public: Allow anyone to read published stories
      // Admin: Authenticated users can read ALL stories (published + drafts)
      allow read: if resource.data.published == true || request.auth != null;
      
      // Admin: Only authenticated users can create, update, delete
      allow write: if request.auth != null;

      // ===== CHAPTERS SUBCOLLECTION =====
      match /chapters/{chapterId} {
        // Public: Allow reading chapters from published stories
        // Admin: Allow authenticated users to read all chapters from any story
        allow read: if get(/databases/$(database)/documents/stories/$(storyId)).data.published == true || request.auth != null;
        
        // Admin: Only authenticated users can create, update, delete chapters
        allow write: if request.auth != null;
      }
    }

    // ===== FALLBACK DENY RULE =====
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
